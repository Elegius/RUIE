<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUIE</title>
    <link rel="icon" type="image/x-icon" href="/icon.ico">
    <link rel="stylesheet" href="styles.css?v=20260201d">
    <!-- Load app.js first -->
    <script src="app.js?v=20260201"></script>
</head>
<body style="margin: 0; padding: 0; background: #0a0e27; min-height: 100vh;">
    <!-- Modern Loading Screen with Progress Indicator -->
    <div id="app-loading" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #0a0e27 0%, #16213e 100%); display: flex !important; align-items: center; justify-content: center; z-index: 99999; visibility: visible !important; overflow: hidden;">
        <!-- Animated background particles -->
        <div style="position: absolute; width: 100%; height: 100%; overflow: hidden; opacity: 0.3;">
            <div style="position: absolute; width: 2px; height: 2px; background: #00c8ff; border-radius: 50%; top: 20%; left: 10%; box-shadow: 0 0 10px #00c8ff; animation: twinkle 3s infinite;"></div>
            <div style="position: absolute; width: 2px; height: 2px; background: #00c8ff; border-radius: 50%; top: 60%; left: 80%; box-shadow: 0 0 10px #00c8ff; animation: twinkle 4s infinite 1s;"></div>
            <div style="position: absolute; width: 2px; height: 2px; background: #00c8ff; border-radius: 50%; top: 40%; left: 50%; box-shadow: 0 0 10px #00c8ff; animation: twinkle 5s infinite 2s;"></div>
            <div style="position: absolute; width: 2px; height: 2px; background: #00c8ff; border-radius: 50%; top: 80%; left: 30%; box-shadow: 0 0 10px #00c8ff; animation: twinkle 3.5s infinite 0.5s;"></div>
        </div>
        
        <!-- Main loading container -->
        <div style="text-align: center; position: relative; z-index: 1; max-width: 500px; padding: 40px;">
            <!-- Glassmorphic card -->
            <div style="background: rgba(22, 33, 62, 0.6); backdrop-filter: blur(20px); border: 1px solid rgba(0, 200, 255, 0.2); border-radius: 20px; padding: 50px 40px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.05);">
                <!-- Logo/Icon -->
                <div style="margin-bottom: 30px;">
                    <div style="display: inline-block; position: relative;">
                        <svg width="80" height="80" viewBox="0 0 80 80" style="filter: drop-shadow(0 0 20px rgba(0, 200, 255, 0.5));">
                            <circle cx="40" cy="40" r="35" fill="none" stroke="url(#gradient1)" stroke-width="2" opacity="0.3"/>
                            <circle cx="40" cy="40" r="30" fill="none" stroke="url(#gradient1)" stroke-width="2" opacity="0.5"/>
                            <circle cx="40" cy="40" r="25" fill="none" stroke="url(#gradient1)" stroke-width="3">
                                <animateTransform attributeName="transform" type="rotate" from="0 40 40" to="360 40 40" dur="3s" repeatCount="indefinite"/>
                            </circle>
                            <path d="M 40 20 L 40 30 M 40 50 L 40 60 M 20 40 L 30 40 M 50 40 L 60 40" stroke="#00c8ff" stroke-width="3" stroke-linecap="round">
                                <animateTransform attributeName="transform" type="rotate" from="0 40 40" to="360 40 40" dur="2s" repeatCount="indefinite"/>
                            </path>
                            <defs>
                                <linearGradient id="gradient1" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#00c8ff;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#0066ff;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>
                </div>
                
                <!-- Title -->
                <div style="font-size: 32px; font-weight: 700; font-family: 'Orbitron', Arial, sans-serif; background: linear-gradient(135deg, #00c8ff 0%, #0099ff 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 10px; letter-spacing: 2px;">
                    RUIE
                </div>
                
                <!-- Subtitle -->
                <div style="font-size: 14px; color: #8899aa; font-family: Arial, sans-serif; margin-bottom: 30px; letter-spacing: 3px; text-transform: uppercase;">
                    RSI UI Editor
                </div>
                
                <!-- Progress Bar Container -->
                <div style="position: relative; width: 100%; height: 4px; background: rgba(0, 200, 255, 0.1); border-radius: 2px; overflow: hidden; margin-bottom: 20px;">
                    <!-- Animated progress bar -->
                    <div id="loading-progress-bar" style="position: absolute; left: 0; top: 0; height: 100%; background: linear-gradient(90deg, #00c8ff 0%, #0099ff 50%, #00c8ff 100%); background-size: 200% 100%; border-radius: 2px; width: 0%; transition: width 0.3s ease; animation: shimmer 2s infinite;">
                    </div>
                </div>
                
                <!-- Status Text -->
                <div id="loading-status" style="font-size: 13px; color: #6688aa; font-family: Arial, sans-serif; min-height: 20px; letter-spacing: 0.5px;">
                    Initializing...
                </div>
                
                <!-- Version/Build Info -->
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(0, 200, 255, 0.1); font-size: 11px; color: #556677; font-family: Arial, sans-serif;">
                    v0.2 Alpha ‚Ä¢ Star Citizen Launcher Theme Editor
                </div>
            </div>
        </div>
        
        <!-- CSS Animations -->
        <style>
            @keyframes shimmer {
                0% { background-position: 200% 0; }
                100% { background-position: -200% 0; }
            }
            @keyframes twinkle {
                0%, 100% { opacity: 0.3; transform: scale(1); }
                50% { opacity: 1; transform: scale(1.5); }
            }
        </style>
    </div>
    
    <script>
    // Inline initialization script - run only once
    console.log('[INLINE] Script starting...');
    
    // Prevent multiple initializations
    if (window.initializationStarted) {
        console.log('[INLINE] Already initialized, skipping');
    } else {
        window.initializationStarted = true;
        
        const loadingStatus = document.getElementById('loading-status');
        const progressBar = document.getElementById('loading-progress-bar');
        let currentProgress = 0;
        
        function updateLoadingStatus(msg, progress) {
            if (loadingStatus) loadingStatus.textContent = msg;
            if (progressBar && progress !== undefined) {
                currentProgress = progress;
                progressBar.style.width = progress + '%';
            }
            console.log('[LOADING]', msg, progress !== undefined ? `(${progress}%)` : '');
        }
        
        // Expose to window so app.js can call it
        window.updateLoadingStatus = updateLoadingStatus;
        
        updateLoadingStatus('Initializing system...', 0);
        
        function hideLoadingScreen() {
            console.log('[hideLoadingScreen] Called');
            const loader = document.getElementById('app-loading');
            console.log('[hideLoadingScreen] loader element:', !!loader);
            if (loader) {
                // Clear the safety timeout since we're hiding
                if (window.absoluteLoaderTimeout) {
                    clearTimeout(window.absoluteLoaderTimeout);
                    console.log('[hideLoadingScreen] Cleared safety timeout');
                }
                
                loader.style.display = 'none';  // Fallback: immediate hide
                loader.style.opacity = '0';
                loader.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    console.log('[hideLoadingScreen] Removing loader after 300ms');
                    loader.remove();
                }, 300);
                console.log('[hideLoadingScreen] Loader hidden');
            } else {
                console.warn('[hideLoadingScreen] Loader element not found!');
            }
        }
        
        function tryStartApp() {
            // Double-check we haven't started already
            if (window.appStarted) {
                console.log('[INLINE] App already started');
                return;
            }
            
            console.log('[INLINE] ======== START OF tryStartApp ========');
            
            try {
                updateLoadingStatus('Loading core systems...', 20);
                console.log('[INLINE] tryStartApp called, typeof startApp:', typeof startApp);
                if (typeof startApp === 'function') {
                    console.log('[INLINE] Calling startApp()');
                    updateLoadingStatus('Starting application...', 40);
                    
                    const result = startApp();
                    console.log('[INLINE] startApp returned:', result);
                    console.log('[INLINE] result type:', typeof result);
                    console.log('[INLINE] result.then type:', typeof (result && result.then));
                    console.log('[INLINE] is promise:', result && typeof result.then === 'function');
                    
                    if (result && typeof result.then === 'function') {
                        console.log('[INLINE] ‚úì startApp returned a promise, setting up handlers');
                        
                        // Set a hard timeout to ensure app loads even if something hangs
                        const appTimeoutId = setTimeout(() => {
                            console.error('[INLINE] ‚è±Ô∏è APP STARTUP TIMEOUT - forcing UI visible after 8s');
                            if (!window.appStarted) {
                                console.error('[INLINE] window.appStarted is still false, forcing cleanup');
                                window.appStarted = true;
                            }
                            updateLoadingStatus('‚ö† Initialization timeout, showing interface...', 100);
                            progressBar.style.background = '#00c8ff';
                            hideLoadingScreen();
                        }, 8000); // Hard 8 second timeout
                        
                        // Simulate progress while app loads
                        setTimeout(() => updateLoadingStatus('Initializing interface...', 60), 200);
                        setTimeout(() => updateLoadingStatus('Loading resources...', 80), 400);
                        
                        result.then(() => {
                            console.log('[INLINE] ‚úÖ startApp promise resolved successfully');
                            clearTimeout(appTimeoutId);
                            updateLoadingStatus('Ready!', 100);
                            setTimeout(() => {
                                console.log('[INLINE] Calling hideLoadingScreen after 300ms delay');
                                hideLoadingScreen();
                            }, 300);
                        }).catch(function(err) {
                            console.error('[INLINE] ‚ùå startApp promise rejected');
                            console.error('[INLINE] Error message:', err?.message || String(err));
                            clearTimeout(appTimeoutId);
                            console.error('[INLINE] Stack:', err?.stack);
                            updateLoadingStatus('‚ö† Error: ' + (err?.message || String(err)), 100);
                            progressBar.style.background = 'linear-gradient(90deg, #ff4444 0%, #ff0000 50%, #ff4444 100%)';
                            // Show error on page but don't reload
                            setTimeout(() => {
                                const errorDiv = document.createElement('div');
                                errorDiv.style.cssText = 'position:fixed;top:80px;left:50%;transform:translateX(-50%);max-width:600px;background:rgba(255,68,68,0.95);color:white;padding:20px 30px;z-index:999999;border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.1);';
                                errorDiv.innerHTML = '<h3 style="margin:0 0 10px 0;font-family:Orbitron,Arial,sans-serif;">‚ö† Startup Error</h3><pre style="white-space:pre-wrap;font-size:12px;margin:0;font-family:monospace;background:rgba(0,0,0,0.2);padding:10px;border-radius:5px;max-height:300px;overflow:auto;">' + (err?.stack || err?.message || String(err)) + '</pre>';
                                document.body.appendChild(errorDiv);
                                // Still hide loading screen on error
                                hideLoadingScreen();
                            }, 100);
                        });
                    } else {
                        console.error('[INLINE] ‚ùå startApp did not return a promise:', result);
                        console.error('[INLINE] typeof result:', typeof result);
                        updateLoadingStatus('‚ö† startApp returned non-promise', 50);
                        setTimeout(hideLoadingScreen, 1000);
                    }
                } else {
                    console.error('[INLINE] ‚ùå startApp not found or not a function');
                    updateLoadingStatus('‚ö† Error: Core system not found', 50);
                    setTimeout(hideLoadingScreen, 1000);
                }
            } catch (err) {
                console.error('[INLINE] ‚ùå Error calling startApp:', err?.message || String(err));
                console.error('[INLINE] Stack:', err?.stack);
                updateLoadingStatus('‚ö† Critical error: ' + (err?.message || String(err)), 100);
                setTimeout(hideLoadingScreen, 2000);
            }
            
            console.log('[INLINE] ======== END OF tryStartApp ========');
        }
        
        // Only use DOMContentLoaded - most reliable
        console.log('[INLINE] Setting up DOMContentLoaded listener');
        updateLoadingStatus('Loading modules...', 10);
        
        // Safety fallback: Always hide loading screen after 10 seconds max
        const absoluteTimeout = setTimeout(() => {
            console.warn('[INLINE] ‚è±Ô∏è ABSOLUTE SAFETY TIMEOUT - hiding loading screen forcefully');
            const loader = document.getElementById('app-loading');
            if (loader && loader.style.display !== 'none') {
                console.warn('[INLINE] Loader still visible, forcing hide');
                loader.style.display = 'none';
                hideLoadingScreen();
            }
        }, 10000);
        
        // Store the timeout ID so it can be cleared when we successfully hide
        window.absoluteLoaderTimeout = absoluteTimeout;
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('[INLINE] DOMContentLoaded fired');
                updateLoadingStatus('DOM ready...', 15);
                setTimeout(tryStartApp, 100);
            });
        } else {
            // DOM already loaded
            console.log('[INLINE] DOM already ready');
            updateLoadingStatus('DOM ready...', 15);
            setTimeout(tryStartApp, 100);
        }
    }
    </script>
    
    <div class="container">
        <!-- Header with Update Manager Button -->
        <header class="header">
            <div class="header-content">
                <h1>RUIE</h1>
                <button id="update-manager-btn" class="header-update-btn" title="Check for updates and manage versions">‚öôÔ∏è Update Manager</button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="content-wrapper">
            <!-- Step 1: Initialize & Extract (Combined) -->
            <!-- Full Width: Path Detection Section -->
            <section class="step page" id="step-1" data-page="1">
                <h2>Step 1: Prepare & Extract</h2>
                
                <!-- FULL WIDTH: App.asar Detection & Selection -->
                <div class="setup-panel" style="width: 100%; margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">üìç App.asar Detection & Selection</h3>
                    </div>
                    <div class="form-group" style="display: flex; align-items: center; gap: 15px; width: 100%;">
                        <div style="display: flex; align-items: center; gap: 10px; flex: 1; position: relative;">
                            <input type="text" id="asarPath" placeholder="Path to app.asar" 
                                   style="flex: 1; cursor: pointer; overflow: hidden; text-overflow: ellipsis; color: #d0d0d0;" 
                                   readonly title="Full path will appear here when selected"
                                   onmouseover="showFullPath(this)" onmouseout="hideFullPath(this)">
                            <span id="path-success-indicator" style="display: none; color: #64c864; font-size: 1.5em; cursor: pointer;" title="Click to browse for app.asar">‚úì</span>
                            <div id="path-tooltip" style="display: none; position: absolute; bottom: -30px; left: 0; background: #1a1a2e; border: 1px solid #64c864; padding: 5px 10px; border-radius: 4px; font-size: 0.85em; white-space: nowrap; z-index: 1000;"></div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button id="browse-btn" class="btn btn-secondary" style="font-size: 0.85em; padding: 8px 12px;">üìÅ Browse</button>
                            <button id="detect-launcher-btn" class="btn btn-secondary" style="font-size: 0.85em; padding: 8px 12px;">üîç Auto-Detect</button>
                            <button id="init-btn" class="btn btn-primary" style="font-size: 0.85em; padding: 8px 12px;">Initialize</button>
                        </div>
                    </div>
                    <div id="init-status" class="status"></div>
                </div>

                <!-- Hidden file input for manual asar selection -->
                <input type="file" id="asarFileInput" style="display: none;" accept=".asar" onchange="handleAsarFileSelection(event)">

                <!-- Two Columns: ASAR Manager + Backup Manager -->
                <div class="setup-layout">
                    <!-- Left Column: ASAR Manager -->
                    <div class="setup-panel setup-left">
                        <h3>ASAR Manager</h3>
                        <p style="color: #a0b0c0; font-size: 0.9em; margin-bottom: 15px;">Extract and manage ASAR versions.</p>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button id="extract-btn" class="btn btn-primary" style="flex: 1; font-size: 0.85em; padding: 8px 12px;">Decompile app.asar</button>
                            <button id="open-latest-extract-btn" class="btn btn-secondary" style="flex: 1; font-size: 0.85em; padding: 8px 12px;" onclick="openLatestExtract()">Open Last Extracted</button>
                        </div>

                        <div id="extract-progress" class="progress" style="display: none; margin-top: 15px;">
                            <div class="progress-bar" id="extract-progress-bar" style="width: 0%;"></div>
                            <div class="progress-text" id="extract-progress-text">Preparing extraction...</div>
                        </div>
                        <div id="extract-status" class="status"></div>

                        <h4 style="color: #8db4d0; margin: 20px 0 10px 0; font-size: 0.95em;">Existing Extractions</h4>
                        <div id="extractsList" class="extracts-list">
                            <div class="extract-item-empty" style="text-align: center; padding: 20px; color: #7a8a9a;">
                                Loading extractions...
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button id="open-extractions-folder-btn" class="btn btn-secondary" style="flex: 1; font-size: 0.85em; padding: 8px 12px;" onclick="openExtractionsFolder()" title="Open extractions directory">üìÇ Open decompiled asars folder</button>
                        </div>
                    </div>

                    <!-- Right Column: Backup Manager -->
                    <div class="setup-panel setup-right">
                        <h3>Backup Manager</h3>
                        <p style="color: #a0b0c0; font-size: 0.9em; margin-bottom: 15px;">Manage your backups. Create snapshots before making changes.</p>
                        
                        <div class="backup-actions" style="margin-bottom: 15px; display: flex; justify-content: center; gap: 10px;">
                            <button id="create-backup-btn" class="btn btn-primary" style="font-size: 0.85em; padding: 8px 12px;" onclick="createNewBackup()">üì¶ Create New Backup</button>
                        </div>
                        
                        <div id="backups-status" class="status"></div>

                        <h4 style="color: #8db4d0; margin: 15px 0 10px 0; font-size: 0.95em;">Existing Backups</h4>
                        <div id="backupsList" class="backups-list">
                            <div class="backup-item-empty" style="text-align: center; padding: 20px; color: #7a8a9a;">
                                No backups yet. Create one to get started.
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button id="open-backups-folder-btn" class="btn btn-secondary" style="flex: 1; font-size: 0.85em; padding: 8px 12px;" onclick="openBackupsFolder()" title="Open backups directory">üìÇ Open backups folder</button>
                        </div>
                    </div>
                </div>

                <div class="page-navigation">
                    <button class="btn btn-secondary" onclick="navigateToPage(2)">Next ‚Üí</button>
                </div>
            </section>

            <!-- Step 2: Colors -->
            <section class="step page" id="step-2" data-page="2" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; gap: 20px;">
                    <div>
                        <h2 style="margin: 0 0 5px 0;">Step 2: Customize Colors</h2>
                        <p style="margin: 0; font-size: 0.9em;">Create your color palette by mapping old colors to new ones.</p>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; flex-shrink: 0;">
                        <div class="color-presets" style="margin: 0; min-width: 250px;">
                            <select id="preset-selector" class="preset-dropdown" onchange="handlePresetChange(this.value)">
                                <option value="">Select a manufacturer preset...</option>
                                <option value="rsi">RSI</option>
                                <option value="aegis-dynamics">Aegis Dynamics</option>
                                <option value="anvil-aerospace">Anvil Aerospace</option>
                                <option value="aopoa">Aopoa</option>
                                <option value="argo">Argo Astronautics</option>
                                <option value="banu">Banu</option>
                                <option value="consolidated-outland">Consolidated Outland</option>
                                <option value="crusader-industries">Crusader Industries</option>
                                <option value="drake-interplanetary">Drake Interplanetary</option>
                                <option value="esperia">Esperia</option>
                                <option value="gatac">Gatac Manufacture</option>
                                <option value="greycat">Greycat Industrial</option>
                                <option value="kruger">Kruger Intergalactic</option>
                                <option value="misc">MISC</option>
                                <option value="origin-jumpworks">Origin Jumpworks</option>
                                <option value="tumbril">Tumbril Land Systems</option>
                                <option value="vanduul">Vanduul</option>
                                <option value="c3rb">C3RB (Custom)</option>
                            </select>
                        </div>
                        <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.85em; white-space: nowrap;" onclick="importThemeFromColors()" title="Import theme from file">üì• Import</button>
                        <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.85em; white-space: nowrap;" onclick="exportCurrentPreset()" title="Export current colors to file">üì§ Export</button>
                        <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 0.85em; white-space: nowrap;" onclick="saveCurrentPreset()" title="Save colors to server">üíæ Save</button>
                    </div>
                </div>

                <div class="split-layout">
                    <div class="editor-panel">
                        <div class="color-mappings">
                            <div id="colorList" class="color-list"></div>
                            <button class="btn btn-secondary" onclick="addColorMapping()">+ Add Color Mapping</button>
                        </div>
                        <div id="colors-status" class="status" style="margin-top: 15px;"></div>
                    </div>

                    <div class="preview-panel" style="display: flex; flex-direction: column;">
                        <div class="preview-header">Live Theme Preview</div>
                        <iframe id="previewFrame" class="preview-frame" src="preview.html" title="Theme Preview" style="flex: 1;"></iframe>
                        <div style="padding: 15px; border-top: 1px solid rgba(0, 212, 255, 0.15);">
                            <button class="btn btn-primary" style="width: 100%;" onclick="applyColors()">Apply Colors</button>
                        </div>
                    </div>
                </div>

                <div class="page-navigation" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="navigateToPage(1)">‚Üê Back</button>
                    <button class="btn btn-secondary" onclick="navigateToPage(3)">Next ‚Üí</button>
                </div>
            </section>

            <!-- Step 3: Media -->
            <section class="step page" id="step-3" data-page="3" style="display: none;">
                <h2>Step 3: Replace Media Files</h2>

                <div class="split-layout">
                    <div class="editor-panel">
                        <div class="media-section">
                            <div class="media-actions">
                                <label class="media-filter-label" for="mediaFilter">Filter:</label>
                                <select id="mediaFilter" class="media-filter" onchange="applyMediaAssetFilter()">
                                    <option value="all">All</option>
                                    <option value="image">Images</option>
                                    <option value="video">Videos</option>
                                </select>
                            </div>
                            <div id="mediaAssetPicker" class="media-asset-picker"></div>
                        </div>
                        <div id="media-status" class="status" style="margin-top: 15px;"></div>
                    </div>

                    <div class="preview-panel" style="display: flex; flex-direction: column;">
                        <div class="preview-header">Live Theme Preview</div>
                        <iframe id="previewFrame" class="preview-frame" src="preview.html" title="Theme Preview" style="flex: 1;"></iframe>
                        <div style="padding: 15px; border-top: 1px solid rgba(0, 212, 255, 0.15);">
                            <button class="btn btn-primary" style="width: 100%;" onclick="applyMedia()">Apply Media Changes</button>
                        </div>
                    </div>
                </div>

                <div class="page-navigation" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="navigateToPage(2)">‚Üê Back</button>
                    <button class="btn btn-secondary" onclick="navigateToPage(4)">Next ‚Üí</button>
                </div>
            </section>

            <!-- Step 4: Music -->
            <section class="step page" id="step-4" data-page="4" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; gap: 20px;">
                    <h2 style="margin: 0;">Step 4: Customize Music</h2>
                    <div class="music-player">
                        <div class="music-player-info">
                            <div class="music-player-title" id="currentTrackName">No track selected</div>
                            <div class="music-player-type" id="currentTrackType"></div>
                        </div>
                        <audio id="musicPlayerElement" controls controlsList="nodownload">
                            Your browser does not support the audio element.
                        </audio>
                    </div>
                </div>

                <div class="editor-panel">
                    <div class="music-section">
                        <h3>Music Playlist</h3>
                        <p class="music-info">The launcher will pick these tracks in random order. Supported formats: OGG (preferred), MP3</p>
                        
                        <div id="musicList" class="music-list"></div>
                        
                        <div class="music-controls">
                            <button class="btn btn-secondary" onclick="addMusicFile()">‚ûï Add Music File</button>
                            <button class="btn btn-secondary" onclick="loadDefaultMusic()">üîÑ Reset to Default</button>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="applyMusic()">Apply Music</button>
                    <div id="music-status" class="status"></div>
                </div>

                <div class="page-navigation" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="navigateToPage(3)">‚Üê Back</button>
                    <button class="btn btn-secondary" onclick="navigateToPage(5)">Next ‚Üí</button>
                </div>
            </section>

            <!-- Step 5: Finalize -->
            <section class="step page" id="step-5" data-page="5" style="display: none;">
                <h2>Step 5: Test, Export & Install</h2>
                <p>Test your theme, export your configuration, or install it to your launcher.</p>

                <div class="finalize-container">
                    <div class="finalize-actions">
                        <div class="action-card">
                            <div class="action-card-header">üß™ Test Theme</div>
                            <div class="action-card-description">Launch the modified launcher to see your theme in action</div>
                            <button class="btn btn-secondary btn-large" id="test-btn" onclick="testTheme()">Test Launcher</button>
                        </div>

                        <div class="action-card">
                            <div class="action-card-header">üíæ Export Theme</div>
                            <div class="action-card-description">Download your theme configuration as a JSON file for sharing or backup</div>
                            <button class="btn btn-secondary btn-large" id="export-btn" onclick="exportTheme()">Export Theme</button>
                        </div>

                        <div class="action-card">
                            <div class="action-card-header">üîß Install Theme</div>
                            <div class="action-card-description">Install your theme to the actual launcher (automatic backup created)</div>
                            <button class="btn btn-success btn-large" id="install-btn" onclick="installTheme()">Install Theme</button>
                        </div>
                    </div>

                    <div id="finalize-status" class="finalize-status"></div>
                </div>
            </section>
        </main>

        <!-- Bottom Navigation with Stepper -->
        <div class="navigation-bar">
            <div class="nav-buttons-left">
                <button class="btn btn-secondary" id="backBtn" onclick="navigateToPage(state.currentPage - 1)">‚Üê Back</button>
            </div>
            
            <div class="stepper-container-bottom">
                <div class="stepper">
                    <div class="stepper-step active" id="stepper-1" onclick="navigateToPage(1)">
                        <div class="stepper-circle">1</div>
                        <div class="stepper-label">Setup</div>
                    </div>
                    <div class="stepper-line"></div>
                    <div class="stepper-step" id="stepper-2" onclick="navigateToPage(2)">
                        <div class="stepper-circle">2</div>
                        <div class="stepper-label">Colors</div>
                    </div>
                    <div class="stepper-line"></div>
                    <div class="stepper-step" id="stepper-3" onclick="navigateToPage(3)">
                        <div class="stepper-circle">3</div>
                        <div class="stepper-label">Media</div>
                    </div>
                    <div class="stepper-line"></div>
                    <div class="stepper-step" id="stepper-4" onclick="navigateToPage(4)">
                        <div class="stepper-circle">4</div>
                        <div class="stepper-label">Music</div>
                    </div>
                    <div class="stepper-line"></div>
                    <div class="stepper-step" id="stepper-5" onclick="navigateToPage(5)">
                        <div class="stepper-circle">5</div>
                        <div class="stepper-label">Finish</div>
                    </div>
                </div>
            </div>
            
            <div class="nav-buttons-right">
                <button class="btn btn-secondary" id="nextBtn" onclick="navigateToPage(state.currentPage + 1)">Next ‚Üí</button>
            </div>
        </div>
    </div>
</body>
</html>
